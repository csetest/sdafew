tosca_definitions_version: hwpaas_tosca_version_1_4_1

inputs:
  image-frontend:
    default: "100.125.1.34:20202/hwcse/sockshop-frontend:0.0.42"
  mongdb_name:
    type: string
  image-orders:
    default: "100.125.1.34:20202/hwcse/sockshop-orders:0.3.0"
  image-payment:
    default: "100.125.1.34:20202/hwcse/sockshop-payment:5.0.0"
  image-user:
    default: "100.125.1.34:20202/hwcse/sockshop-user:2.0.0"
  image-carts:
    default: "100.125.1.34:20202/hwcse/sockshop-carts:0.1.0"
  image-shipping:
    default: "100.125.1.34:20202/hwcse/sockshop-shipping:0.1.0"
  image-catalogue:
    default: "100.125.1.34:20202/hwcse/sockshop-cat:7.0.0"
  image-rabbitmq :
    default: "100.125.1.34:20202/hwcse/rabbitmq:latest"
  image-queuemaster:
    default: "100.125.1.34:20202/hwcse/sockshop-queuemaster:0.2.0"
  image-mongodb-orders:
    default: "100.125.1.34:20202/hwcse/mongo:1.0.0"
  image-mongodb-users:
    default: "100.125.1.34:20202/hwcse/mongo:1.0.0"
  image-mongodb-carts:
    default: "100.125.1.34:20202/hwcse/mongo:1.0.0"
  image-mysql:
    default: "100.125.1.34:20202/hwcse/sockshop-mysql:1.0.0"
  sc_host:
    default: "100.125.1.34"
  frontend_port:
    default: 32709
  orders_port:
    default: 7091
  queuemaster_port:
    default: 7094
  user_port:
    default: 8010
  payment_port:
    default: 9099
  carts_port:
    default: 7092
  shipping_port:
    default: 7093
  rabbitmq_port:
    default: 5672
  catalogue_port:
    default: 9098
  mongodb_port:
    default: 27017
  mysql_port:
    default: 3306
  frontend_name:
    default: "frontend"
  orders_name:
    default: "orders"
  queuemaster_name:
    default: "queuemaster"
  shipping_name:
    default: "shipping"
  carts_name:
    default: "carts"
  user_name:
    default: "user"
  payment_name:
    default: "payment"
  catalogue_name:
    default: "catalogue"
  rabbitmq_name:
     default: "rabbitmq"
  mongodb_users_name:
    default: "mongodb-users"
  mongodb_orders_name:
    default: "mongodb-orders"
  mongodb_carts_name:
    default: "mongodb-carts"
  mysql_name:
    default: "mysql"
  mongo_user:
    default: "mongo-user"
  mongo_password:
    default: "mongo-password"
  mongo_host:
    default: "10.247.83.139:27017"
  user_database:
    default: "mongodb"
  mysql_root_password:
    default: "default_password"
  mysql_database:
    default: "socksdb"

node_templates:
  cse-localtime-volume:
    type: hwpaas.nodes.LocalVolume
    properties:
      name: localtime
      type: local_storage
      host_path: /etc/localtime

  cse-resolv-volume:
    type: hwpaas.nodes.LocalVolume
    properties:
      name: resolv
      type: local_storage
      host_path: /etc/resolv.conf

  bptest-host:
    type: hwpaas.nodes.Cluster
    properties:
      name: acmeair-tianming
      namespace: default
      instances: 1
  frontend-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: frontend-app
          relationship: hwpaas.relationships.ConsistsOf

  frontend-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: frontend_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: frontend
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: orders
          relationship: hwpaas.relationships.ConnectsTo

  frontend:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        container_spec:
          image: { get_input: image-frontend }
        service_spec:
          type: NodePort
          ports:
            - port: 32709
              nodePort: { get_input: frontend_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
  orders-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: orders-app
          relationship: hwpaas.relationships.ConsistsOf

  orders-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: orders_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: orders
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: queuemaster
          relationship: hwpaas.relationships.ConnectsTo

  orders:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "SC_HOST"
            value: { get_input: sc_host }
        container_spec:
          image: { get_input: image-orders }
        service_spec:
          type: ClusterIP
          ports:
            - port: 7091
              nodePort: { get_input: orders_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
 # queuemaster 
  queuemaster-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: queuemaster-app
          relationship: hwpaas.relationships.ConsistsOf

  queuemaster-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: queuemaster_name }
      custom_spec:
        rabbitmq_host: { get_attribute: [rabbitmq, Service, clusterIP] }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: queuemaster
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: shipping
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: rabbitmq
          relationship: hwpaas.relationships.ConnectsTo

  queuemaster:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "SC_HOST"
            value: { get_input: sc_host }
        container_spec:
          image: { get_input: image-queuemaster }
        service_spec:
          type: ClusterIP
          ports:
            - port: 7094
              nodePort: { get_input: queuemaster_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
  # shipping
  shipping-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: shipping-app
          relationship: hwpaas.relationships.ConsistsOf

  shipping-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: shipping_name }
      custom_spec:
        rabbitmq_host: { get_attribute: [rabbitmq, Service, clusterIP] }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: shipping
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: carts
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: rabbitmq
          relationship: hwpaas.relationships.ConnectsTo

  shipping:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "SC_HOST"
            value: { get_input: sc_host}
        container_spec:
          image: { get_input: image-shipping }
        service_spec:
          type: ClusterIP
          ports:
            - port: 7093
              nodePort: { get_input: shipping_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: true

  carts-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: carts-app
          relationship: hwpaas.relationships.ConsistsOf

  carts-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: carts_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: carts
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: user
          relationship: hwpaas.relationships.ConnectsTo

  carts:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "MONGDB_SERVICE_HOST"
            value: { get_input: mongdb_name }
          - name: "SC_HOST"
            value: { get_input: sc_host }
        container_spec:
          image: { get_input: image-carts }
        service_spec:
          type: ClusterIP
          ports:
            - port: 7092
              nodePort: { get_input: carts_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: true
  user-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: user-app
          relationship: hwpaas.relationships.ConsistsOf

  user-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: user_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: user
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: payment
          relationship: hwpaas.relationships.ConnectsTo

  user:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
         # - name: "MONGO_HOST"
          #  value: { get_input: mongo_host }
          - name: "USER_DATABASE"
            value: { get_input: user_database }
        container_spec:
          image: { get_input: image-user }
        service_spec:
          type: ClusterIP
          ports:
            - port: 8081
              nodePort: { get_input: user_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: true
  payment-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: payment-app
          relationship: hwpaas.relationships.ConsistsOf

  payment-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: payment_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: payment
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: catalogue
          relationship: hwpaas.relationships.ConnectsTo

  payment:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        container_spec:
          image: { get_input: image-payment }
        service_spec:
          type: NodePort
          ports:
            - port: 9099
              nodePort: { get_input: payment_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
  catalogue-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: catalogue-app
          relationship: hwpaas.relationships.ConsistsOf

  catalogue-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: catalogue_name }
      custom_spec:
        mysql_ip: { get_attribute: [mysql, Service, clusterIP] }
        mysql_port: { get_attribute: [mysql, Service, ports, 0, port] }
        mysql_user: catalogue_user
        mysql_db: socksdb
        mysql_password: default_password
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: catalogue
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: rabbitmq
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: mysql
          relationship: hwpaas.relationships.ConnectsTo

  catalogue:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        container_spec:
          image: { get_input: image-catalogue }
        service_spec:
          type: ClusterIP
          ports:
            - port: 9098
              nodePort: { get_input: catalogue_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: true
  rabbitmq-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: mongodb-orders-app
          relationship: hwpaas.relationships.ConsistsOf

  rabbitmq-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: rabbitmq_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: rabbitmq
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo
      - dependency:
          node: mongodb-users
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: mongodb-orders
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: mongodb-carts
          relationship: hwpaas.relationships.ConnectsTo
      - dependency:
          node: mysql
          relationship: hwpaas.relationships.ConnectsTo

  rabbitmq:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
        container_spec:
          image: { get_input: image-rabbitmq }
        service_spec:
          type: ClusterIP
          ports:
            - port: 5672
              nodePort: { get_input: rabbitmq_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: true
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: true

  mongodb-users-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: mongodb-users-app
          relationship: hwpaas.relationships.ConsistsOf

  mongodb-users-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: mongodb_users_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: mongodb-users
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo

  mongodb-users:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "MONGO_INITDB_ROOT_USERNAME"
            value: {get_input: mongo_user}
          - name: "MONGO_INITDB_ROOT_PASSWORD"
            value: {get_input: mongo_password}
        container_spec:
          image: { get_input: image-mongodb-users }
        service_spec:
          type: ClusterIP
          ports:
            - port: 27017
              nodePort: { get_input: mongodb_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: false
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: false
# mongodb-orders
  mongodb-orders-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: mongodb-orders-app
          relationship: hwpaas.relationships.ConsistsOf

  mongodb-orders-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: mongodb_orders_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: mongodb-orders
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo

  mongodb-orders :
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        container_spec:
          image: { get_input: image-mongodb-orders }
        service_spec:
          type: ClusterIP
          ports:
            - port: 27017
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: false
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: false
# mongodb-carts
  mongodb-carts-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: mongodb-carts-app
          relationship: hwpaas.relationships.ConsistsOf

  mongodb-carts-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: mongodb_carts_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: mongodb-carts
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo

  mongodb-carts :
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        container_spec:
          image: { get_input: image-mongodb-carts }
        service_spec:
          type: ClusterIP
          ports:
            - port: 27017
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: false
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: false
  mysql-group:
    type: hwpaas.nodes.AppGroup
    requirements:
      - member:
          node: mysql-app
          relationship: hwpaas.relationships.ConsistsOf

  mysql-app:
    type: hwpaas.nodes.Application
    properties:
      type: container
      name: { get_input: mysql_name }
    requirements:
      - host:
          node: bptest-host
          relationship: hwpaas.relationships.HostedOn
      - package:
          node: mysql
          relationship: hwpaas.relationships.PackageConsistsOf
      - volume:
          node: cse-localtime-volume
          relationship: hwpaas.relationships.AttachesTo
      - volume:
          node: cse-resolv-volume
          relationship: hwpaas.relationships.AttachesTo

  mysql:
    type: hwpaas.nodes.SoftwareComponent
    properties:
      package:
        package_type: container
        env:
          - name: "MYSQL_ROOT_PASSWORD"
            value: { get_input: mysql_root_password }
          - name: "MYSQL_DATABASE"
            value: { get_input: mysql_database }
        container_spec:
          image: { get_input: image-mysql }
        service_spec:
          type: ClusterIP
          ports:
            - port: 3306
              nodePort: { get_input: mysql_port }
        resource_spec:
          request:
            cpu: 1000m
            memory: 1024Mi
          limit:
            cpu: 1000m
            memory: 1024Mi
        volumes:
          - name: localtime
            mountpath: /etc/localtime
            readOnly: false
          - name: resolv
            mountpath: /etc/resolv.conf
            readOnly: false 

outputs:
    mysql_ip:
        description: ip of mysql
        value: {get_attribute: [mysql,ips]}
    mysql_port:
        description: port of mysql
        value: { get_input: mysql_port }
    mongodb_carts_ip:
        description: ip of mongodb_carts
        value: {get_attribute: [mongodb-carts,ips]}
    mongodb_carts_port:
        description: port of mongodb_carts
        value: { get_input: mongodb_port }
    mongodb_orders_ip:
        description: ip of mongodb_orders
        value: {get_attribute: [mongodb-orders,ips]}
    mongodb_carts_port:
        description: port of mongodb_orders
        value: { get_input: mongodb_port }
    mongodb_orders_ip:
        description: ip of mongodb_orders
        value: {get_attribute: [mongodb-orders,ips]}
    mongodb_users_port:
        description: port of mongodb_users
        value: { get_input: mongodb_port }
